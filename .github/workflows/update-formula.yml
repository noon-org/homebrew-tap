name: Update Formula

on:
  repository_dispatch:
    types: [update-formula]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.2.0)'
        required: true

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.client_payload.version }}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_num=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Download SHA256 checksums
        run: |
          VERSION=${{ steps.version.outputs.version }}
          for target in aarch64-apple-darwin x86_64-apple-darwin aarch64-unknown-linux-gnu x86_64-unknown-linux-gnu; do
            curl -sL "https://github.com/noon-org/finetype/releases/download/${VERSION}/finetype-${VERSION}-${target}.tar.gz.sha256" \
              | awk '{print $1}' > /tmp/sha256-${target}
          done

      - name: Update formula
        run: |
          VERSION=${{ steps.version.outputs.version }}
          VERSION_NUM=${{ steps.version.outputs.version_num }}

          SHA_ARM_MAC=$(cat /tmp/sha256-aarch64-apple-darwin)
          SHA_X86_MAC=$(cat /tmp/sha256-x86_64-apple-darwin)
          SHA_ARM_LINUX=$(cat /tmp/sha256-aarch64-unknown-linux-gnu)
          SHA_X86_LINUX=$(cat /tmp/sha256-x86_64-unknown-linux-gnu)

          cat > Formula/finetype.rb << FORMULA
          class Finetype < Formula
            desc "Semantic type classifier for data profiling â€” detects 151 data types from raw strings"
            homepage "https://noon.sh/projects/finetype/"
            license "MIT"
            version "${VERSION_NUM}"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/noon-org/finetype/releases/download/${VERSION}/finetype-${VERSION}-aarch64-apple-darwin.tar.gz"
                sha256 "${SHA_ARM_MAC}"
              else
                url "https://github.com/noon-org/finetype/releases/download/${VERSION}/finetype-${VERSION}-x86_64-apple-darwin.tar.gz"
                sha256 "${SHA_X86_MAC}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/noon-org/finetype/releases/download/${VERSION}/finetype-${VERSION}-aarch64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_ARM_LINUX}"
              else
                url "https://github.com/noon-org/finetype/releases/download/${VERSION}/finetype-${VERSION}-x86_64-unknown-linux-gnu.tar.gz"
                sha256 "${SHA_X86_LINUX}"
              end
            end

            def install
              bin.install "finetype"
            end

            test do
              assert_match "finetype", shell_output("#{bin}/finetype --version")
            end
          end
          FORMULA

          # Fix indentation (heredoc adds extra spaces)
          sed -i 's/^          //' Formula/finetype.rb

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/finetype.rb
          git diff --staged --quiet && echo "No changes" && exit 0
          git commit -m "Update finetype to ${{ steps.version.outputs.version }}"
          git push
